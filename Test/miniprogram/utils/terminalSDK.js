(()=>{"use strict";const n=function(){function n(n){var e,t=this;this.notifyFuncs=[],this.rspFuncs=[];var o=n.svraddr||"127.0.0.1",r=n.svrport||"3000";n.ssl,this.socket=null,this.socket=wx.connectSocket({url:"wss://"+o+":"+r+"/"}),wx.onSocketOpen(n.ready),wx.onSocketClose(n.close),wx.onSocketError(n.error),wx.onSocketMessage((function(n){var e=JSON.parse(n.data);if(e.notify&&e.notify>0){var o=e.notify;"function"==typeof t.notifyFuncs[o]&&t.notifyFuncs[o](e)}if(e.rsp&&e.rsp>0){var r=e.rsp;"function"==typeof t.rspFuncs[r]&&t.rspFuncs[r](e)}}))}return n.prototype.sendData=function(n){wx.sendSocketMessage({data:n})},n}(),e=function(){function n(){}return n.getCurrentTime=function(){var n=new Date,e=n.getMonth()+1,t=n.getDate()+1,o=n.getHours(),r=n.getMinutes(),i=n.getSeconds();return e<=9&&(e="0"+e),t<=9&&(t="0"+t),o<=9&&(o="0"+o),r<=9&&(r="0"+r),i<=9&&(i="0"+i),"["+n.getFullYear()+"-"+e+"-"+t+" "+o+":"+r+":"+i+"]"},n.error=function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];console.error(n.getCurrentTime()+"["+e+"][error]: "+t)},n.debug=function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];console.debug(n.getCurrentTime()+"["+e+"][debug]: "+t)},n.info=function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];console.info(n.getCurrentTime()+"["+e+"][info]: "+t)},n._instance=new n,n}(),t=function(){function t(){if(t.wrapper)throw Error("tsdkManagerWrapper has exist");t.wrapper=this}return t.prototype.build=function(o,r,i,s,c,u){var a=this;if(e.info("tsdkManagerWrapper","tsdkManagerWrapper has build"),!t.socketService||1!=t.socketService.socket.readyState){var p=new Promise((function(n,t){a.onWebsocketReady=function(t){n(""),e.info("tsdkManagerWrapper","websocket connect sucesss"),s&&"function"==typeof s&&s.call(null,"websocket链接成功")}})),f={svraddr:o,svrport:r,ssl:i,close:function(n){c&&"function"==typeof c&&c.call(null,n)},ready:this.onWebsocketReady,error:function(n){u&&"function"==typeof u&&u.call(null,n)}};return t.socketService=new n(f),p}e.info("tsdkManagerWrapper","websocket is connecting ")},t.getInstance=function(){return t.wrapper},t.wrapper=new t,t}(),o=function(){function n(){}return n.subscribe=function(t,o){n.topics[t]||(n.topics[t]=[]);var r=++n.Uid;e.info("Observer","subscribe topic:"+t+", uid="+r),n.topics[t].push({token:r,func:o})},n.publish=function(e,t){if(!n.topics[e])return!1;for(var o=0;o<n.topics[e].length;o++)n.topics[e][o].func(t)},n.reconnect=function(){n.isReconnect=1},n.resetReconnect=function(){n.isReconnect=0},n.getReconnectStatus=function(){return n.isReconnect},n.topics={},n.Uid=-1,n.isReconnect=0,n}(),r=function(n,e,r,i){var s=this;this.wrapper=t.getInstance();var c=function(){i&&"function"==typeof i&&i(null)},u=function(){},a=function(){o.publish("onEvtWebSocketClose","服务器连接异常"),o.reconnect(),setTimeout((function(){s.wrapper.build(n,e,r,c,a,u)}),3e3)};this.wrapper.build(n,e,r,c,a,u)},i=function(){function n(n){this.serviceTunnel=n.socket}return n.prototype.sendData=function(n){var e=JSON.stringify(n);this.serviceTunnel.socket&&this.serviceTunnel.sendData(e)},n.prototype.callbackResponse=function(n,e){n.response&&"function"==typeof n.response&&(this.serviceTunnel.rspFuncs[e]=n.response)},n.prototype.login=function(n,e){this.callbackResponse(e,1001);var t={cmd:1001,description:"tsdk_login",param:{loginParam:n}};this.sendData(t)},n.prototype.reconnectBindWs=function(n,e){this.callbackResponse(e,1002);var t={cmd:1002,description:"tsdk_reconnect_bind_ws",param:{userId:n}};this.sendData(t)},n.prototype.setBasicEvent=function(n){"function"==typeof n.onEvtLoginSuccess&&(this.serviceTunnel.notifyFuncs[1002]=n.onEvtLoginSuccess),"function"==typeof n.onEvtLoginFailed&&(this.serviceTunnel.notifyFuncs[1003]=n.onEvtLoginFailed)},n}(),s=function(){function n(){if(n.wrapper)throw Error("tsdkLoginWrapper has exist");n.wrapper=this}return n.prototype.build=function(){e.info("tsdkLoginWrapper","tsdkLoginWrapper has build"),n.tsdkLogin=new i({socket:t.socketService})},n.getInstance=function(){return n.wrapper},n.prototype.login=function(e){var t={response:{}},o=new Promise((function(n,e){t.response=function(e){n(e)}}));return n.tsdkLogin.login(e,t),o},n.prototype.reconnectBindWs=function(e){var t={response:{}},o=new Promise((function(n,e){t.response=function(e){n(e)}}));return n.tsdkLogin.reconnectBindWs(e,t),o},n.prototype.registerLoginEvent=function(e){n.tsdkLogin.setBasicEvent(e)},n.wrapper=new n,n}();var c=function(n,e,t,o){return new(t||(t=Promise))((function(r,i){function s(n){try{u(o.next(n))}catch(n){i(n)}}function c(n){try{u(o.throw(n))}catch(n){i(n)}}function u(n){var e;n.done?r(n.value):(e=n.value,e instanceof t?e:new t((function(n){n(e)}))).then(s,c)}u((o=o.apply(n,e||[])).next())}))},u=function(n,e){var t,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(n,s)}catch(n){i=[6,n],o=0}finally{t=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}};const a=function(){function n(){this.wrapper=s.getInstance(),this.wrapper.build(),this.registerLoginEvent()}return n.prototype.login=function(n,e){return c(this,void 0,void 0,(function(){var t;return u(this,(function(o){switch(o.label){case 0:return[4,this.wrapper.login(n)];case 1:return t=o.sent(),e(t),[2]}}))}))},n.prototype.reconnectBindWs=function(n,e){return c(this,void 0,void 0,(function(){var t;return u(this,(function(o){switch(o.label){case 0:return[4,this.wrapper.reconnectBindWs(n)];case 1:return t=o.sent(),e(t),[2]}}))}))},n.prototype.registerLoginEvent=function(){e.info("tsdkLoginService","registerLoginEvent"),this.wrapper.registerLoginEvent({onEvtLoginSuccess:n.handleOnEvtLoginSuccess,onEvtLoginFailed:n.handleonEvtLoginFailed})},n.handleOnEvtLoginSuccess=function(n){o.publish("onEvtLoginSuccess",n)},n.handleonEvtLoginFailed=function(n){o.publish("onEvtLoginFailed",n)},n}(),p=function(){function n(n){this.serviceTunnel=n.socket}return n.prototype.sendData=function(n){var e=JSON.stringify(n);this.serviceTunnel.socket&&this.serviceTunnel.sendData(e)},n.prototype.callbackResponse=function(n,e){n.response&&"function"==typeof n.response&&(this.serviceTunnel.rspFuncs[e]=n.response)},n.prototype.singlePersonChat=function(n,e){this.callbackResponse(e,3001);var t={cmd:3001,description:"tsdk_single_person_chat",param:{chatInfo:n}};this.sendData(t)},n.prototype.setBasicEvent=function(n){"function"==typeof n.onEvtNewsInComing&&(this.serviceTunnel.notifyFuncs[3002]=n.onEvtNewsInComing)},n}(),f=function(){function n(){if(n.wrapper)throw Error("tsdkChatWrapper has exist");n.wrapper=this}return n.prototype.build=function(){e.info("tsdkChatWrapper","tsdkChatWrapper has build"),n.tsdkChat=new p({socket:t.socketService})},n.getInstance=function(){return n.wrapper},n.prototype.singlePersonChat=function(e){var t={response:{}},o=new Promise((function(n,e){t.response=function(e){n(e)}}));return n.tsdkChat.singlePersonChat(e,t),o},n.prototype.registerChatEvent=function(e){n.tsdkChat.setBasicEvent(e)},n.wrapper=new n,n}();const l=function(){function n(){this.wrapper=f.getInstance(),this.wrapper.build(),this.registerChatEvent()}return n.prototype.singlePersonChat=function(n,e){return t=this,o=void 0,i=function(){var t;return function(n,e){var t,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(n,s)}catch(n){i=[6,n],o=0}finally{t=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}(this,(function(o){switch(o.label){case 0:return[4,this.wrapper.singlePersonChat(n)];case 1:return t=o.sent(),e(t),[2]}}))},new((r=void 0)||(r=Promise))((function(n,e){function s(n){try{u(i.next(n))}catch(n){e(n)}}function c(n){try{u(i.throw(n))}catch(n){e(n)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(n){n(t)}))).then(s,c)}u((i=i.apply(t,o||[])).next())}));var t,o,r,i},n.prototype.registerChatEvent=function(){e.info("tsdkChatService","registerChatEvent"),this.wrapper.registerChatEvent({onEvtNewsInComing:n.handleOnEvtNewsInComing})},n.handleOnEvtNewsInComing=function(n){o.publish("onEvtNewsInComing",n)},n}(),v=function(){function n(e){n.managerService=new r(e.svraddr,e.port,e.ssl,this.reconnectSucessCallback),n.loginService=new a,n.tsdkChatService=new l,this.registerWebsocketEvent(),this.registerLoginEvent(),this.registerChatEvent()}return n.prototype.reconnectSucessCallback=function(){o.getReconnectStatus()&&(n.loginService=new a,o.resetReconnect()),o.publish("onEvtWebSocketConnect","服务器连接成功")},n.prototype.login=function(e,t){n.loginService.login(e,t)},n.prototype.reconnectBindWs=function(e,t){n.loginService.reconnectBindWs(e,t)},n.prototype.singlePersonChat=function(e,t){n.tsdkChatService.singlePersonChat(e,t)},n.prototype.notify=function(e,t){var o=n.__listeners[e];if(!o)return!1;for(var r=0;r<o.length;r++)"function"==typeof o[r]&&o[r](t)},n.prototype.on=function(e,t){n.__listeners[e]||(n.__listeners[e]=[]),n.__listeners[e].push(t)},n.prototype.registerLoginEvent=function(){var n=this;o.subscribe("onEvtLoginSuccess",(function(e){n.notify("onEvtLoginSuccess",e)})),o.subscribe("onEvtLoginFailed",(function(e){n.notify("onEvtLoginFailed",e)}))},n.prototype.registerWebsocketEvent=function(){var n=this;o.subscribe("onEvtWebSocketConnect",(function(e){n.notify("onEvtWebSocketConnect",e)})),o.subscribe("onEvtWebSocketClose",(function(e){n.notify("onEvtWebSocketClose",e)}))},n.prototype.registerChatEvent=function(){var n=this;o.subscribe("onEvtNewsInComing",(function(e){n.notify("onEvtNewsInComing",e)}))},n.__listeners={},n}(),h=function(){function n(){}return n.tsdkCreateClient=function(t,o){try{n.tsdkClient=new v(t)}catch(n){e.error("terminalSDK","terminal create failed..."+n)}return n.tsdkClient?(o&&"undefined"!=o.onEvtLoginSuccess&&n.tsdkClient.on("onEvtLoginSuccess",o.onEvtLoginSuccess),o&&"undefined"!=o.onEvtLoginFailed&&n.tsdkClient.on("onEvtLoginFailed",o.onEvtLoginFailed),o&&"undefined"!=o.onEvtNewsInComing&&n.tsdkClient.on("onEvtNewsInComing",o.onEvtNewsInComing),o&&"undefined"!=o.onEvtWebSocketConnect&&n.tsdkClient.on("onEvtWebSocketConnect",o.onEvtWebSocketConnect),o&&"undefined"!=o.onEvtWebSocketClose&&n.tsdkClient.on("onEvtWebSocketClose",o.onEvtWebSocketClose),n.tsdkClient):""},n}();module.exports={terminalSDK:h}})();